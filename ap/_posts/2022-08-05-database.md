---
title: データベースの用語
comment: true
---


## データベースの設計
### 概念設計
概念データモデルを作成する. `E-Rモデル`や`UMLクラス図`を使用して記述する.  

#### データ項目の洗い出し
1. データ項目名の標準化
2. データ項目の意味の定義
3. データ項目の桁数や型の統一
4. 各データ項目の発生源や発生量の明確化

### 論理設計
概念データモデルを、論理データモデルと言われるデータベース構造モデルに変換する.  
主キーや外部キーを含めたテーブル構造を作成する.  
ビューの定義を行うのもこの段階.  

### 物理設計
データ量、データの利用頻度、パフォーマンス性を考慮してデータベースの物理的構造を決める.  

## 3層スキーマ
### 外部スキーマ
利用者やアプリケーションプログラムから見たデータの定義を行う. 
### 概念スキーマ
データベースの論理的構造とその内容を定義する. 論理データモデルが該当.
### 内部スキーマ
物理的内容の定義を行う. 

### E-R図
#### 多対多の関係
多対多の関係は、1対多、多対1の関係に分解する.  

## 関係データベース
### キー
#### スーパーキー
表中の行を一位に特定できる属性、あるいは属性の組みを`スーパーキー`とよぶ.  
#### 候補キー
必要最小限の属性によって構成されるスーパーキー.  
一意性制約が設定される.  
#### 主キー
複数の候補キーの中から任意に選んだ1つのキー.  
主キーに選ばれなかった残りの候補キーを`代理キー`と呼ぶ.  
#### 外部キー
関連する他の表を参照する属性あるいは属性の組み.  
2つの表の間に「1対多」の関係がある場合、「多」側の表に「1」側の表の主キーあるいは主キー以外の候補キーを参照する属性を持たせて、これを外部キーとする. これにより、外部キーの値が被参照表に存在することを保証する`参照制約`が確保できる.  

## 正規化
### 正規化の目的
正規化の目的は、データ操作に伴う更新時以上の発生を防ぐこと.  
正規化により属性間の関数従属を少なくし、かつ、データの重複を排除することで更新時異常の発生を防ぐ.  
ただし、正規化を進めると表の結合が必要になり処理時間がかかる.  

### 関数従属
ある属性xの値が決まると他の属性yの値が一意的に決まる関係.  

### 第１正規化
繰り返し部分を排除して平坦にする操作.  

#### データ操作での不具合
##### 修正時異常
レコードを変更する場合、該当する行を全て同時に変更しないとデータに不整合が発生する.  

##### 挿入時異常
主キーがNULLのレコードは登録できない.  

##### 削除時異常
関係従属するデータが１つだけの場合、関係従属するデータを削除すると、元となるデータも削除されてしまう.  



### 第２正規化
全ての非キー属性が、各候補機ーに完全関数従属である状態にする操作.  
つまり、部分関数従属している項目は全て他の表として独立させる.  


### 第３正規化
候補キーに推移的関数従属している非キー属性を別の表に分解する.  
元の表には外部キーを残す.


## データベースの演算

SQLの操作方法は、  
[ゼロから始めるデータベース操作](../sql.md)
を参照.  

## SQL
### 副問合せ
SELECT文のFROM句やWHERE句、HAVING句などに指定されている入れ子になったSELECT文.  
#### INを用いた副問合せ
```sql
SELECT 社員コード, 社員名
	FROM 社員表
	WHERE 年齢 IN (SELECT 指定年齢 FROM 調査対象表)
```
この例の場合、まず副問合せが実行され、調査対象表から指定年齢が取り出されたのち、
主問合せが実行される.  

#### EXISTS述語
副問合せの結果が1つ以上であれば真、それ以外は偽と評価する.  

```sql
SELECT 社員コード, 社員名
	FROM 社員表
	WHERE EXISTS (SELECT * FROM 調査対象表　-- 相関問い合わせ
		WHERE 社員表.年齢 = 調査対象表.指定年齢
	)
```


同じ処理を`ANY`で表すこともできる.  
```sql

SELECT 社員コード, 社員表
	FROM 社員表
	WHERE 年齢 = ANY(SELECT 指定年齢 FROM 調査対象表)
```


### 参照関係をもつ表の更新
CREATE TABLE文において、`REFERENCE`句の後に指定する.  

|参照動作|内容|
|-------|---|
|NO ACTION|削除を実行するが、これにより参照制約が満たされなくなった場合は実行失敗となり、削除処理は取り消される. |
|RESTRICT|削除を実行する際、参照制約を検査し、当該行を参照している参照表の行があれば削除を拒否する. |
|CASCADE|削除を実行し、さらに当該行を参照している参照表の行があれば、その行も削除する. |
|SET DEFAULT|被参照表の行が削除されたとき、それを参照している参照表の外部キーへの規定値を設定する. |
|SET NULL|被参照表の行が削除されたとき、それを参照している参照表の外部キーへNULLを設定する. |


### ビューの定義
ビューとは、実表の一部あるいは複数の表から必要な行や列を取り出し、あたかも１つの表であるかのようにめせかけた仮想表.  
データを検索するだけであれば、制約はあるものの実表と同様に操作することができる.  

#### ビューの目的
1. 行や列を特定の条件で絞り込んだビューだけをアクセスさせることによって、基となる表(基底表)のデータの一部を隠蔽して保護する手段を提供する.  
2. 利用者が必要とするデータをビューにまとめることによって、表操作を容易に行えるようにする.  

#### 更新不可能なビュー
一意にレコードを特定できないビューは更新不可能なビュー.  

1. SELECT文に式や集合関数、あるいは`DISTINCT`を使用したSELECT文で定義されている.  
2. `GROUP BY`句や`HAVING`句を使用したSELECT文で定義されている.  

### オブジェクトの処理権限
複数の利用者がデータベースを利用できるようにするため、スキーマ所有者以外にも処理権限を付与する必要がある.  

#### 処理権限の付与

```sql
GRANT 権限リスト ON 表名 TO 利用者リスト
```

#### 処理権限の取り消し

```sql
GRANT 権限リスト ON 表名 TO 利用者リスト
```


## 埋込み方式
### 静的SQL
あらかじめ決められたSQL文をプログラム中に埋込み実行する方式.  
データベースの表から1行を取り出すことを`非カーソル処理`という.  

```sql
EXEC SQL SELECT 列名リスト INTO :ホスト変数名リスト
	FROM 表名
	WHERE ...
```

### 動的SQL
SQL文を動的に作成し実行する方式.  

### ホスト変数
データベースとプログラムのインターフェースとなる変数.  

### カーソル処理
検索の結果が複数行になる場合、`カーソル処理`を行う.  


## データベース管理システム
### 同時実行制御
複数のトランザクションを同時に実行しても、矛盾を起こすことなく処理を実行するメカニズム.  

#### デッドロック
ロックを複数のデータに対して行おうとしたときに、互いにロックの解除を待ち続けている状態.  
データを占有する順序が等しいトランザクション同士ではデッドロックは起きない.  
デッドロックが発生した場合、ロールバックなどにより１つのトランザクションを強制的に終了させることで、解除することができる.  

#### 2相ロック方式
使用するデータに対し一斉にロックをかけ、処理後に一斉にロックを解除する方式.  
直列可能性は保証されるが、デッドロック発生の可能性は残る.  

#### 木規約
データに順番をつけ、その順番通りにロックをかけていく方式.  
デッドロックの発生がない. 直列可能性を保証する.  

#### ロックの粒度
粒度が小さいほど同時実行性を高めることができるが、ロックの回数が多くなり、ロック制御のためのオーバーヘッドが増大する.  
粒度が大きいほど、ロックの解除待ちが長くなり、同時実行性は低下する.  

#### 多版同時実行制御
同時実行性を高め、かつ一貫性のあるトランザクション処理を実現する仕組み.  
占有ロックと共有ロックの同時確保を可能にすることで同時実行性を高め、後続トランザクションに、現在からさかのぼったある時点における一貫性のあるデータを提供することで整合性を欠いたデータの参照を防ぐ.  

#### 時刻印アルゴリズム
ロック制御をせずに同時実行制御を行う方法.  
トランザクションが発生した時刻とデータの持つ読込み時刻、あるいは書込み時刻を比較し、読み書きの判断を行う.  


### 障害回復管理
#### 障害の種類
- 記憶媒体の故障により、データが消失する`媒体障害`
- DBMSやOSのバグ、オペレータの誤操作によってシステムがダウンする`システム障害`
- プログラムのバグ、またはデッドロック発生によるトランザクションの強制終了など、実行中のトランザクションが異常終了する`トランザクション障害`

#### 事前対策
##### ログファイル
更新前ログと更新後ろぐなどの更新履歴を記録したもの.  

##### バックアップファイル

|バックアップの種類|説明|
|---------------|----|
|フルバックアップ|全てのデータをバックアップする|
|差分バックアップ|直前のフルバックアップからの変更分だけをバックアップする|
|増分バックアップ|直前のフルバックアップまたは増分バックアップからの変更分だけをバックアップする|

##### 媒体障害からの回復
媒体障害が発生したときは、バックアップファイルの更新後ログを用いて、`ロールフォワード処理`によりデータベースの回復処理を行う.  

##### トランザクション障害からの回復
ログファイルの更新前ログを用いた`ロールバック制御`により、データベースの内容をトランザクション開始時点の状態に戻す.  

##### システム障害からの回復
障害発生直前のチェックポイントまで戻り、更新ログを用いたロールバック処理やロールフォワード処理を行うだけで障害発生直前の状態にデータベースを回復できる.  


### 問い合わせ処理の効率化
#### インデックス
データベースへのアクセス効率を向上させるために使用される.  
`WHERE`, `GROUP BY`, `ORDER BY`に頻繁に使用されるデータ列にインデックスを付与することで処理速度の向上が期待できる. ただし、必ずしもその効果が期待できる子は限らない.  

##### インデックスを付与する際の注意点
1. インデックス列に対して`NOT条件`や`NULL条件`, `LIKE条件`または計算や関数を使用した問い合わせ条件の場合、インデックスが使われない可能性があるためその効果は期待できない. 
2. 更新が頻繁に行われる表の場合、データの更新と共にインデックスの更新も発生するため、かえって処理時間が長くなる.
3. レコードが少ない場合、インデックス効果は期待できない. 
4. データ値の種類が少ない列に、通常のインデックスを付与してもインデックスが使われないため効果がない.
5. データ値の重複具合に大きな偏りがある場合は効果が少ない.


##### B<sup>+</sup>インデックス
RDBMSのインデックスとして最も多く使われている. 節にはキー値と部分木へのポインタを、葉にはデータ(キー値とデータ格納位置)を格納する構造. 

- 値一致検索だけでなく、範囲検索にも優れている
- 最下位検索部どうしをポインタで結ぶことで順次検索も高速化している
- データの追加削除に伴い必要な場合は、ブロックの分割や併合を行う
- １件のデータを検索するときの節へのアクセス回数は、木の深さに比例する. このため、索引部の節に多くのキー値を持たせることで、木の深さが浅くなり検索の効率化が測れる. 


##### ビットマップインデックス
インデックスを付与する列のデータ値ごとにビットマップを作成する方式.  

##### ハッシュインデックス
ハッシュ関数を用いてキー値とデータを直接関係づける方式.  
一意検索に優れているが、全件検索や不等号などを使った範囲検索には不向き.  

#### 複合インデックス
複数の列を組み合わせて１つのインデックスとしたもの.  

#### オプティマイザ
SQL文を実行する際に、問合せをどのように処理するのかを決めるクエリ最適化の機能. 

##### コストベースのオプティマイザ
ディスクファイルのI/O回数、入出力バッファやログバッファの使用状況といったRDBMSが収集した統計情報をもとに表へのアクセスや表の結合にかかるI/O、CPUのコストなどを見積り、最適なアクセス方法並びに結合順序や結合方法を選択する.  

##### ルールベースのオプティマイザ
実行するSQL文を分解し、その分解された情報と所定のルールによってアクセス方法を選択する.  

### データベースのチューニング
性能低下が目立ってきた場合、適切なチューニングを実施しなければならない.  

#### 複数ディスクへの分割
アクセスの集中によってディスクのI/O待ち時間が増加した場合、表単位でデータを複数のディスクへ分割する.

#### 表の分割
1つの表に格納するデータが大量である場合、データを複数のディスクに格納することで並列処理が可能になり、アクセス性能が向上する.  
- キーレンジ分割方式
	分割に使用するキーの値の範囲により、その値に割り当てられたディスクに分割格納する.
- ハッシュ分割方式
	分割に使用するキーの値にハッシュ関数を適用し、その値に割り当てられたディスクに分割格納する.
	

#### データベースの再編成
使用できない断片的な未使用部分が増加し、データベース全体のアクセス効率が低下するため、定期的にデータベースの再編成`ガベージコレクション`を行う.  

## 分散データベース
### 分散データベースシステムの機能

